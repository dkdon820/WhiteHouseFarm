<?xml version="1.0" encoding="utf-8"?>

<CustomShader version="3">
    <Textures>
        <Texture name = "mTexture1Diffuse"  defaultColorProfile = "sRGB"        />
        <Texture name = "mTexture1Normal"   defaultColorProfile = "linearRGB"   />
        <Texture name = "mTexture2Diffuse"  defaultColorProfile = "sRGB"        />
        <Texture name = "mTexture2Normal"   defaultColorProfile = "linearRGB"   />
        <Texture name = "mTexture3Diffuse"  defaultColorProfile = "sRGB"        />
        <Texture name = "mTexture3Normal"   defaultColorProfile = "linearRGB"   />
    </Textures>
    <LodLevel startDistance="0">
        <CodeInjections> 
            <CodeInjection position = "SAMPLERS">
<![CDATA[
sampler2D mTexture1Diffuse;
sampler2D mTexture1Normal;
sampler2D mTexture2Diffuse;
sampler2D mTexture2Normal;
sampler2D mTexture3Diffuse;
sampler2D mTexture3Normal;
]]>
            </CodeInjection>
            <CodeInjection position = "FS_GLOBALS">
<![CDATA[
    float4 gVertexColor;
]]>
            </CodeInjection>
            <CodeInjection position = "START_FS">
<![CDATA[
    globals.gVertexColor = float4( 0.0, 0.0, 0.0, 0.0 );
#if defined( VERTEX_COLOR ) 
    globals.gVertexColor     = In.vs.vertexColor.rgba;
#endif
]]>
            </CodeInjection>
            <CodeInjection position = "GET_UNNORMALIZED_TANGENT_SPACE_NORMAL_FS">
<![CDATA[
#if defined( NORMAL_MAP )
    float3 mNormal  = tex2D( normalMap, In.vs.NORMALMAP_TEXCOORD ).xyz - 0.5;

    float3 mNormal1 = tex2D( mTexture1Normal, In.vs.NORMALMAP_TEXCOORD ).xyz - 0.5;
    float3 mNormal2 = tex2D( mTexture2Normal, In.vs.NORMALMAP_TEXCOORD ).xyz - 0.5;
    float3 mNormal3 = tex2D( mTexture3Normal, In.vs.NORMALMAP_TEXCOORD ).xyz - 0.5;
    
    mNormal.rgb = lerp( mNormal.rgb, mNormal1.rgb, globals.gVertexColor.r );
    mNormal.rgb = lerp( mNormal.rgb, mNormal2.rgb, globals.gVertexColor.g );
    mNormal.rgb = lerp( mNormal.rgb, mNormal3.rgb, globals.gVertexColor.b );

    return mNormal;
 #endif
]]>
            </CodeInjection>
            <CodeInjection position = "POST_ALBEDO_FS">
<![CDATA[
    #if defined( VERTEX_COLOR ) 
        #undef VERTEX_COLOR
    #endif
    
    float4 mAlbedo1   = tex2D( mTexture1Diffuse, In.vs.ALBEDOMAP_TEXCOORD);
    float4 mAlbedo2   = tex2D( mTexture2Diffuse, In.vs.ALBEDOMAP_TEXCOORD);
    float4 mAlbedo3   = tex2D( mTexture3Diffuse, In.vs.ALBEDOMAP_TEXCOORD);
    
    albedo.rgba = lerp( albedo.rgba, mAlbedo1.rgba, globals.gVertexColor.r );
    albedo.rgba = lerp( albedo.rgba, mAlbedo2.rgba, globals.gVertexColor.g );
    albedo.rgba = lerp( albedo.rgba, mAlbedo3.rgba, globals.gVertexColor.b );
]]>
            </CodeInjection>
        </CodeInjections>
    </LodLevel>
</CustomShader>
